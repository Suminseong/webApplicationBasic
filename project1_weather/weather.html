<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.11/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js"
        integrity="sha512-4F1cxYdMiAW98oomSLaygEwmCnIP38pb4Kx70yQYqRwLVCs3DbRumfBq82T08g/4LJ/smbFGFpmeFlQgoDccgg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
    <link rel="stylesheet" href="style.css" />
    <title>날씨</title>
</head>

<body>
    <div class="status"></div>
    <header>
        <div id="aside">
            <img id="ico-menu" src="icon/menu-icon.png" alt="Menu Icon">
        </div>
        <div class="header_center">
            <div id="cityName">
                <p id="bigCity">Incheon</p>
            </div>
            <div id="gps">
                <img class="ico-gps" src="icon/gps-icon.png" alt="GPS Icon">
            </div>
        </div>
        <div id="settingSide">
            <img id="ico-setting" src="icon/setting-icon.png" alt="Settings Icon">
        </div>
    </header>

    <!--로띠로띠로띠로띠로띠로띠로띠로띠로띠로띠로띠로띠-->
    <div id="content">
        <div id="weather-lottie"></div>
    </div>

    <!--하단바-->
    <div id="weather-info">
        <div class="navbar">
            <div class="nav">
                <p class="nav-select" id="today">오늘예보</p>
            </div>
            <div class="nav">
                <p id="weekly">주간예보</p>
            </div>
            <div class="nav">
                <p id="rainCast">강수예측</p>
            </div>
        </div>
        <div class="container">
            <div class="info-card-main"><!--밑에서 처음부터 보이는 친구-->
                <div class="home-visible">
                    <div class="now-weather">
                        <div class="main-text-area">
                            <p class="p-14px" id="prep"></p>
                            <p class="p-34px" id="curr"></p>
                        </div>
                        <img class="currentIcon" src="icon/default.png" alt="weather">
                    </div>
                    <div class="gps-city">
                        <div class="gps">
                            <img class="ico-gps" src="icon/gps-icon.png" alt="GPS Icon">
                        </div>
                        <div id="cityName">
                            <p id="cityName">Incheon</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="info-card-sub"></div>
        </div>
    </div>



    <script>
        $(document).ready(function () {
            let currentAnimation = null; // 현재 Lottie 애니메이션 객체를 저장하는 변수

            const iconCodeMapping = { //날씨 아이콘 매핑
                '01': 'clear_sky',
                '02': 'few_clouds',
                '03': 'scattered_clouds',
                '04': 'broken_clouds',
                '09': 'shower_rain',
                '10': 'rain',
                '11': 'thunderstorm',
                '13': 'snow',
                '50': 'mist'
            };

            const weatherStatusMapping = { //한국어로도
                '01': '맑음',
                '02': '구름 조금',
                '03': '구름 많음',
                '04': '흐림',
                '09': '소나기',
                '10': '비',
                '11': '뇌우',
                '13': '눈',
                '50': '안개'
            };

            // 커스텀 아이콘 경로 반환 함수
            function getCustomIconPath(iconCode) {
                const iconNumber = iconCode.slice(0, 2); // 두 자리 숫자 코드 추출
                const timeOfDay = iconCode.slice(2);    // d, n 추출
                const weatherCondition = iconCodeMapping[iconNumber];

                if (weatherCondition) {
                    return `icon/${weatherCondition}_${timeOfDay}.png`;
                } else {
                    return `icon/default.png`;
                }
            }

            // 매핑 객체: OpenWeatherMap의 icon 코드 → Lottie 애니메이션 JSON 파일명
            const lottieMapping = {
                '01d': 'lottie-sunny.json',
                '01n': 'lottie-clear-night.json',
                '02d': 'lottie-cloudy.json',
                '02n': 'lottie-cloudy-night.json',
                '09d': 'lottie-rain-showers.json',
                '09n': 'lottie-rain-showers-night.json',
                '10d': 'lottie-rain.json',
                '10n': 'lottie-rain-night.json',
                '11d': 'lottie-thunderstorm.json',
                '11n': 'lottie-thunderstorm-night.json',
                '13d': 'lottie-snow.json',
                '13n': 'lottie-snow-night.json',
                '50d': 'lottie-mist.json',
                '50n': 'lottie-mist-night.json'
            };

            // Lottie 애니메이션 JSON 경로 반환 함수
            function getLottieAnimationPath(iconCode) {
                return `anim/${lottieMapping[iconCode] || 'default.json'}`;
            }

            function updateWeatherIcon(iconCode) {
                // 아이콘 경로를 얻기 위한 함수
                const iconPath = getCustomIconPath(iconCode);
                $(".currentIcon").attr("src", iconPath);
            }

            function getWeatherStatus(iconCode) {
                const iconNumber = iconCode.slice(0, 2); // 아이콘 코드의 첫 두 자리 추출
                return weatherStatusMapping[iconNumber] || '알 수 없음'; // 매핑된 상태 반환. 아마 한국어 문자형으로 나올것
            }

            // Lottie 애니메이션 업데이트 함수
            function updateLottieAnimation(iconCode) {
                const lottiePath = getLottieAnimationPath(iconCode);

                // 기존 애니메이션 중단 및 제거
                if (currentAnimation) {
                    currentAnimation.destroy();
                }

                // 새로운 Lottie 애니메이션 초기화
                currentAnimation = lottie.loadAnimation({
                    container: $('#weather-lottie')[0],
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: lottiePath
                });

                currentAnimation.play();
            }

            // 날씨 데이터 가져오기 및 UI 업데이트
            function fetchWeatherData(lat, lng) {
                const apiKey = "25b7bd10b57e76dec116bf982ffca3dd";
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${apiKey}&units=metric&lang=kr`;
                const urlForecast = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lng}&appid=25b7bd10b57e76dec116bf982ffca3dd&units=metric&lang=kr`

                // OpenWeatherMap API 호출
                $.getJSON(url, function (data) {
                    console.log(data);
                    const city = data.name;
                    const weather = data.weather[0].main;
                    const temp = data.main.temp;
                    const iconCode = data.weather[0].icon;
                    const weatherStatus = getWeatherStatus(iconCode);

                    // Lottie 애니메이션 업데이트
                    updateLottieAnimation(iconCode);

                    updateWeatherIcon(iconCode);

                    // UI 업데이트
                    $("#curr").text(weatherStatus);

                    $("#bigCity").text(`${city}`);
                });

                $.getJSON(urlForecast, function (data) {
                    let nowPop = data.list[0].pop

                    $("#prep").text(`강수확률 ${nowPop}%`);
                })
            }

            // GPS 좌표 가져오기
            function getGPSCoordinates(callback) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function (position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            callback({ lat, lng });
                        },
                        function (error) { //오류 예외처리
                            let errorMsg = '';
                            switch (error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg = "위치 권한이 거부되었습니다.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg = "위치 정보를 사용할 수 없습니다.";
                                    break;
                                case error.TIMEOUT:
                                    errorMsg = "위치 정보를 가져오는데 시간이 초과되었습니다.";
                                    break;
                                default:
                                    errorMsg = "알 수 없는 오류가 발생했습니다.";
                            }
                            callback({ error: errorMsg });
                        }
                    );
                } else {
                    callback({ error: "브라우저에서 위치 정보를 지원하지 않습니다." });
                }
            }

            // 페이지 로드 후 초기화
            getGPSCoordinates(function (result) {
                if (result.error) {
                    alert(result.error);
                } else {
                    fetchWeatherData(result.lat, result.lng);
                }
            });

            $(".nav p").on("click", function () {
                // 모든 아이템에서 'nav-select' 클래스 제거
                $(".nav p").removeClass("nav-select");

                // 클릭한 아이템에 'nav-select' 클래스 추가
                $(this).addClass("nav-select");
            });

            // 도시명을 클릭하여 새로고침
            $('.header_center').on('click', function () {
                $('#bigCity').text('Loading...');
                getGPSCoordinates(function (result) {
                    if (result.error) {
                        alert(result.error);
                    } else {
                        fetchWeatherData(result.lat, result.lng);
                    }
                });
            });
        });


    </script>
</body>

</html>